node ('ec2_java_maven') {
    withCredentials([file(credentialsId: '6ad0a02e-19c2-4824-bb25-3c751a383d10', variable: 'MVN_SETTINGS_XML')]) {
    
        withEnv([
            "JAVA_HOME=${tool 'oracle-jdk-8'}",
            "PATH+MAVEN=${tool 'maven-3.3.9'}/bin:${env.JAVA_HOME}/bin",
            "CURRENT_DEV_VERSION=${env.CURRENT_DEV_VERSION}",
            "NEXT_DEV_VERSION=${env.NEXT_DEV_VERSION}",
            "MVN_SETTINGS_XML=${env.MVN_SETTINGS_XML}",
            ]) 
            {
                stage ('Info')
                {
                    // RCF Adding INFO messages.
                    echo "DBG: JAVA_HOME: $JAVA_HOME"
                    echo "DBG: PATH+MAVEN: $PATH+MAVEN"
                    echo "DBG: CURRENT_DEV_VERSION: $CURRENT_DEV_VERSION"
                    echo "DBG: NEXT_DEV_VERSION: $NEXT_DEV_VERSION"
                    echo "DBG: MVN_SETTINGS_XML: $MVN_SETTINGS_XML"
                }
                stage ('Create Rice Release Branch')
                {
                    withCredentials([usernamePassword(credentialsId: 'feb1872d-77aa-4ec0-be3f-c7d7d629f50e', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) 
                    {
                        echo "Checkout Rice:"
                        env.ReleaseInfo = input message: 'Release Information',
                            parameters: [
                                string(
                                    defaultValue: '7.20170511-ua-release99', 
                                    description: 'Enter Next Version:', 
                                    name: 'NEXT_VERSION'), 
                                string(
                                    defaultValue: '7.20170511-ua-release98', 
                                    description: 'Enter Current Version:', 
                                    name: 'CURRENT_VERSION')], 
                            submitterParameter: 'approver'
                        echo "NEXT_VERSION = " + env.ReleaseInfo['NEXT_VERSION']
                        echo "CURRENT_VERSION = ${env.ReleaseInfo['CURRENT_VERSION']}"
                        echo env.ReleaseInfo.NEXT_VERSION + " " + env.ReleaseInfo.CURRENT_VERSION
                        echo "Answered by " + env.ReleaseInfo['approver']
                    }
                }
                stage ('Create KFS Release Branch')
                {        
                    withCredentials([usernamePassword(credentialsId: 'feb1872d-77aa-4ec0-be3f-c7d7d629f50e', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) 
                    {
                        cleanWs()
                        checkout([$class: 'GitSCM', branches: [[name: '*/ua-development']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'feb1872d-77aa-4ec0-be3f-c7d7d629f50e', url: 'https://github.com/ua-eas/financials.git']]])
                        sh "git config user.name $GIT_USERNAME"
                        sh 'git config user.email katt-toolsadm@.list.arizona.edu'
                        sh 'git config --local credential.helper "!p() { echo username=\\$GIT_USERNAME; echo password=\\$GIT_PASSWORD; }; p"'

                        // TRY CATCH
                        sh "git checkout -b RCF-$NEXT_DEV_VERSION"
                        sh 'mvn versions:set -DgenerateBackupPoms=false -DnewVersion="$CURRENT_DEV_VERSION"'
                        sh 'git add .'
                        sh 'git status'
                        sh 'git commit -m "RCFJenkins: Setting pom release version: $CURRENT_DEV_VERSION"'
                        sh 'git status'
                        echo "CURRENT_VERSION = ${env.ReleaseInfo['CURRENT_VERSION']}"
                        // sh 'git push -u origin RCF-$NEXT_DEV_VERSION'
                        // sh 'git status'
                    }
                }
            }
            
    }
}
